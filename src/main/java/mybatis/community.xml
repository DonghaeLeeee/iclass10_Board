<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="community">
	<!-- Community.java vo 클래스를 정의하고 하세요. 1. 메인글 글쓰기 : insert 2. 글내용수정 : update 
		3. 글삭제 : delete 4. 글 보기 : select -->
	<insert id="insert" parameterType="org.iclass.vo.Community"
		useGeneratedKeys="false">
		<!-- 오라클은 idx를 시퀀스를 이용하여 만듭니다. useGeneratedKeys = "false"-->
		INSERT INTO community
		(idx,writer,title,content)
		VALUES
		(community_idx_seq.nextval,#{writer},#{title},#{content})
		<!-- insert 후에 증가된 시퀀스값 (현재값) 가져오기 : idx 필드에 저장하기 -->
		<selectKey keyProperty="idx" resultType="long" order="AFTER">
			SELECT
			community_idx_seq.currval
			FROM dual
		</selectKey>
		
		
		<!-- mysql은 autoincrement 속성 설정하므로 useGeneratedKeys="true"
		<insert id="insert" parameterType="org.iclass.vo.Community" 
			keyProperty="idx" keyColumn="idx" useGeneratedKeys="true" > -->
	</insert>
	<!-- null 허용한 컬럼은 타입을 알려주어 NULL 이 입력되도록 한다. -->


	<update id="update" parameterType="org.iclass.vo.Community">
		UPDATE COMMUNITY
		SET
		title=#{title}, content=#{content} ,ip=#{ip}
		WHERE idx=#{idx}
	</update>


	<delete id="delete" parameterType="int">
		DELETE FROM community
		WHERE
		idx=#{idx}
	</delete>


	<select id="selectByIdx" parameterType="int" 
	resultType="org.iclass.vo.Community">
		SELECT * FROM community
		WHERE
		idx=#{idx}   <!-- PK로 조회 -->
	</select>
	
	
	
	<select id="count" resultType="int">
	SELECT COUNT(*) FROM COMMUNITY c ;
	</select>
	
	
	<update id="setReadCount" parameterType="int">
	UPDATE COMMUNITY 
	SET READCOUNT = READCOUNT +1
	WHERE IDX = #{idx};
	</update>
	
	
	<select id="commentsCount" resultType="int">
	SELECT count(*) FROM 
	COMMUNITYCOMMENTS WHERE MREF = #{mref};
	</select>

	<!-- 메인글의 댓글 갯수 업데이트 -->
	<update id="setCommentCount" parameterType="int">
	UPDATE COMMUNITY 
	SET COMMENTCOUNT =
	(SELECT count(*) FROM COMMUNITYCOMMENTS 
	WHERE mref=#{idx})
	WHERE idx=#{idx};
	</update>
	
	
	
</mapper>